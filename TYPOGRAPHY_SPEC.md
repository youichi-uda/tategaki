# 縦書き日本語組版仕様書

本ドキュメントは、tategakiパッケージの実装において遵守すべき日本語縦書き組版のルールを定義します。

## 参考規格・ガイドライン

- JIS X4051:2004 日本語文書の組版方法
- W3C Requirements for Japanese Text Layout（日本語組版処理の要件）
- CSS Text Module Level 3/4

## 1. 圏点（けんてん / Emphasis Marks）

### 定義
圏点は、文字を強調するために文字の横に付加される記号です。傍点（ぼうてん）とも呼ばれます。

### 位置仕様
- **縦書きの場合**: 文字の右側（視覚的に文字の右隣）に配置
- **横書きの場合**: 文字の上側に配置
- **垂直位置**: 文字の上下中央に配置

### 詳細な配置ルール
1. **X軸位置（縦書き）**:
   - 文字のX座標 + オフセット（正方向）
   - 推奨オフセット: fontSize * 0.6
2. **Y軸位置（縦書き）**:
   - 文字の上下中央
   - 計算方法: characterPosition.dy + (fontSize / 2) - (kentenSize / 2)
   - 簡易計算: characterPosition.dy + fontSize * 0.4 ～ 0.5

### 実装上の注意
- 圏点のサイズは本文のフォントサイズの15～20%程度
- 文字と圏点の間隔は適切に保つ（fontSize * 0.5 ～ 0.7程度）

## 2. 禁則処理（きんそくしょり / Kinsoku Shori）

### 定義
行頭や行末に配置してはいけない文字の規則です。JIS X 4051およびJLREQを参考に、シンプルなルールセットを実装しています。

### 行頭禁則（ぎょうとうきんそく / gyoto kinsoku）
以下の文字は行頭に配置できません：
- **句読点**: 。、
- **閉じ括弧**: 」
- **長音記号**: ー

### 行末禁則（ぎょうまつきんそく / gyomatsu kinsoku）
以下の文字は行末に配置できません：
- **開き括弧**: （「【『〈《

### ぶら下げ処理（burasage）
行末で禁則文字が出現した場合の処理方法：

#### ぶら下げ可能な文字
以下の文字は行の外にぶら下げることができます：
- **句読点**: 。、
- **閉じ括弧**: 」

#### ぶら下げ不可（追い込み必須）
以下の文字は必ず追い込み（oikomi）処理を行います：
- **長音記号**: ー

### 分離禁止処理
以下の文字が連続する場合、途中で改行してはいけません：

#### リーダー（必ずペアで使用）
- **三点リーダー**: …… (U+2026を2つ)
- **二点リーダー**: ‥‥ (U+2025を2つ)

#### ダッシュ類（連続時）
- **長音記号**: ーー
- **ダッシュ**: ――、——、––、－－

#### 感嘆符・疑問符（連続時）
- **組み合わせ**: ！！、？？、！？、？！、!!、??、!?、?!

**重要**: リーダーとダッシュは、ペアが分離されない限り行頭に配置可能です。分離されそうになった場合は追い込み（oikomi）処理を行います。

### 実装方法
1. 行の折り返し位置で禁則文字をチェック
2. 禁則に該当する場合、前方または後方の適切な位置を探す
3. **ぶら下げ（burasage）**: 小さい文字（。、」）を行の外にぶら下げる
4. **追い込み（oikomi）**: 前の文字を同じ行に詰め込む
5. 分離禁止文字のチェック: ペア文字が分離されないように処理

### 処理の優先順位
1. 行頭禁則のチェック（gyoto kinsoku）
2. 行末禁則のチェック（gyomatsu kinsoku）
3. 分離禁止のチェック（paired characters）
4. ぶら下げまたは追い込みの適用

## 3. 文字配置

### 基本ルール
- 文字は各セルの中央に配置
- 回転文字（ラテン文字等）も適切に中央揃え
- 文字間のスペーシングは一定に保つ

### 座標系
- X軸: 横方向（列の位置）、右の列ほどX座標が小さい（負方向に進む）
- Y軸: 縦方向（列内の位置）、下に行くほどY座標が大きい

### 文字の中央配置
```
offsetX = -(textPainter.width / 2)
offsetY = 0.0  // ベースライン位置
```

## 4. 約物（やくもの）調整

### 半角約物
以下の約物は半角（0.5文字幅）として扱うことができます：
- 。、

### ぶら下げ組
行末の句読点は行の外にぶら下げることができます。

### 行頭字下げ
開き括弧が行頭に来る場合、字下げを行うことができます。

## 5. 文字の重なり防止

### ルール
- 各文字は独立したセルに配置
- セル間の間隔は適切に保つ
- 圏点やルビは本文と重ならないように配置

### チェック項目
- 文字どうしが重なっていないか
- 圏点が文字と重なっていないか
- ルビが隣の文字と重なっていないか
- 行間が適切か

## 6. 縦中横（たてちゅうよこ / Tatechuyoko）

### 定義
縦書き中に横組みで配置する文字列（主に2桁の数字や英単語）。

### 適用対象
- 2桁の数字（例: 12、25）
- 短い英単語（実装により異なる）

### 配置方法
- 文字を横向きに配置
- 全体を1文字分のスペースに収める
- 縦方向の中央に配置

## 実装優先順位

1. **最優先**: 圏点の位置修正（文字の右側中央）
2. **高優先**: 禁則処理の正確な実装
3. **高優先**: 文字の重なり・ズレの修正
4. **中優先**: 約物調整
5. **低優先**: 細かな調整・最適化

## 検証方法

1. 各サンプルのスクリーンショットを撮影
2. 以下をチェック:
   - 圏点が文字の右側中央に来ているか
   - 句読点が行頭に来ていないか
   - 文字が重なっていないか
   - 文字の位置がずれていないか
3. 実際の縦書き文書（Web上の画像等）と比較

## 7. JIS X 4051:2004 準拠状況

### 実装済み機能

- ✅ 基本的な縦書き配置（右から左への行送り）
- ✅ 禁則処理（追い込み・ぶら下げの選択可能）
- ✅ ルビ（縦書き、親文字の右側配置）
- ✅ 圏点（傍点）
- ✅ 縦中横（2桁数字の自動検出）
- ✅ 句読点の右上配置（fontSize × 0.75右、fontSize × 0.75上）
- ✅ 小書き仮名の右寄せ配置（fontSize × 0.25右、天地中央）
- ✅ 約物の位置調整（開き括弧：fontSize × 0.2左、閉じ括弧：fontSize × 0.2左）
- ✅ 行頭開き括弧のインデント（gyotoIndent：fontSize × 0.1右）

### 未実装または改善が必要な機能

#### 高優先

1. **行末約物の詰め処理**
   - 句読点や閉じ括弧が行末に来た場合、次の行の頭に半角分の空きを詰める
   - 現在は連続約物の詰めのみ一部実装済み

2. **分離禁止処理**
   - 数字と単位（「10cm」など）を行分割させない
   - 姓と名を分離させない
   - 未実装

3. **和欧文混植時の空き量調整**
   - 日本語とLatin文字の間に1/4emの空きを入れる
   - 未実装

#### 中優先

4. **行末約物の均等配置**
   - 行の文字を均等に配置
   - 未実装

5. **字下げ・字上げ**
   - 段落の最初の行の字下げ
   - 未実装

6. **長音記号・ダッシュ類の扱い** ✅ 実装済み
   - ー（長音記号、U+30FC）- 行頭禁則（単独）、分離禁止（連続時）
   - －（全角ハイフンマイナス、U+FF0D）- 分離禁止（連続時）
   - ―（ダッシュ、U+2015）- 分離禁止（連続時）
   - —（emダッシュ、U+2014）- 分離禁止（連続時）
   - –（enダッシュ、U+2013）- 分離禁止（連続時）
   - **重要**: 連続するダッシュ（――等）は分離禁止だが、単独では行頭配置可能
   - 参考: JLREQ Issue #285, #276

#### 低優先

7. **漢文処理**
   - 返り点、送り仮名
   - 未実装

8. **注記処理**
   - 脚注、傍注
   - 未実装

9. **複数段組**
   - 段組レイアウト
   - 未実装

### 文字クラスと禁則処理

JIS X 4051:2004では文字をクラス分けし、各クラスごとに処理方法を規定しています。
本実装では、実用性を重視したシンプルなルールセットを採用しています。

#### 行頭禁則文字（現在の実装）
- 句読点: 。、
- 閉じ括弧: 」
- 長音記号: ー (U+30FC)

#### 行末禁則文字（現在の実装）
- 開き括弧: （「【『〈《

#### 分離禁止文字（現在の実装）
- リーダー: …… (U+2026×2)、‥‥ (U+2025×2)
- ダッシュ類: ーー、―― (U+2015)、—— (U+2014)、–– (U+2013)、－－ (U+FF0D)
- 感嘆符・疑問符: ！！、？？、！？、？！、!!、??、!?、?!

#### ぶら下げ可能文字（現在の実装）
- 句読点: 。、
- 閉じ括弧: 」

#### 設計方針の変更点
従来のJIS X 4051完全準拠から、以下の方針に変更しました：

1. **行頭禁則の縮小**
   - 閉じ括弧は」のみに限定（）】』等は削除）
   - 小書き仮名の禁則を削除
   - 感嘆符・疑問符の禁則を削除

2. **リーダー・ダッシュの扱い**
   - 行頭禁則から削除
   - 分離禁止処理に移行
   - 連続する場合のみ分離を防止、単独では行頭配置可能

3. **理由**
   - Web上の実際の日本語組版を参考
   - 過度な禁則は読みにくさを招く可能性
   - 柔軟な改行を可能にする

#### 今後の検討項目
- 中点（・）の扱い
- 長音記号の禁則処理を無効化するオプション（狭い段組対応）
- 約物の自動詰め処理の強化

## 参考資料

- [W3C 日本語組版処理の要件](https://w3c.github.io/jlreq/)
- [JIS X4051:2004](https://kikakurui.com/x4/X4051-2004-02.html)
- [JIS X 4051 - Wikipedia](https://ja.wikipedia.org/wiki/JIS_X_4051)
- [JISX4051:2004 日本語文書の組版方法](https://kikakurui.com/x4/X4051-2004-02.html)
- [JIS X 4051（日本語文書の組版方法） - JAGAT](https://www.jagat.or.jp/past_archives/content/view/3509.html)
- [圏点 - Wikipedia](https://ja.wikipedia.org/wiki/圏点)
- [CSS text-emphasis-position](https://developer.mozilla.org/ja/docs/Web/CSS/text-emphasis-position)
