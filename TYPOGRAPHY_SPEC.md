# 縦書き日本語組版仕様書

本ドキュメントは、tategakiパッケージの実装において遵守すべき日本語縦書き組版のルールを定義します。

## 参考規格・ガイドライン

- JIS X4051:2004 日本語文書の組版方法
- W3C Requirements for Japanese Text Layout（日本語組版処理の要件）
- CSS Text Module Level 3/4

## 1. 圏点（けんてん / Emphasis Marks）

### 定義
圏点は、文字を強調するために文字の横に付加される記号です。傍点（ぼうてん）とも呼ばれます。

### 位置仕様
- **縦書きの場合**: 文字の右側（視覚的に文字の右隣）に配置
- **横書きの場合**: 文字の上側に配置
- **垂直位置**: 文字の上下中央に配置

### 詳細な配置ルール
1. **X軸位置（縦書き）**:
   - 文字のX座標 + オフセット（正方向）
   - 推奨オフセット: fontSize * 0.6
2. **Y軸位置（縦書き）**:
   - 文字の上下中央
   - 計算方法: characterPosition.dy + (fontSize / 2) - (kentenSize / 2)
   - 簡易計算: characterPosition.dy + fontSize * 0.4 ～ 0.5

### 実装上の注意
- 圏点のサイズは本文のフォントサイズの15～20%程度
- 文字と圏点の間隔は適切に保つ（fontSize * 0.5 ～ 0.7程度）

## 2. 禁則処理（きんそくしょり / Kinsoku Shori）

### 定義
行頭や行末に配置してはいけない文字の規則です。

### 行頭禁則（ぎょうとうきんそく）
以下の文字は行頭に配置できません：
- 句読点: 。、．，
- 閉じ括弧: ）」】』〉》
- 繰り返し記号: ー々
- 小書き仮名: っゃゅょゎァィゥェォャュョヮ等

### 行末禁則（ぎょうまつきんそく）
以下の文字は行末に配置できません：
- 開き括弧: （「【『〈《

### 実装方法
1. 行の折り返し位置で禁則文字をチェック
2. 禁則に該当する場合、前方または後方の適切な位置を探す
3. 追い出し（oidashi）: 禁則文字を次行に送る
4. 追い込み（oikomi）: 前の文字を同じ行に詰め込む

## 3. 文字配置

### 基本ルール
- 文字は各セルの中央に配置
- 回転文字（ラテン文字等）も適切に中央揃え
- 文字間のスペーシングは一定に保つ

### 座標系
- X軸: 横方向（列の位置）、右の列ほどX座標が小さい（負方向に進む）
- Y軸: 縦方向（列内の位置）、下に行くほどY座標が大きい

### 文字の中央配置
```
offsetX = -(textPainter.width / 2)
offsetY = 0.0  // ベースライン位置
```

## 4. 約物（やくもの）調整

### 半角約物
以下の約物は半角（0.5文字幅）として扱うことができます：
- 。、

### ぶら下げ組
行末の句読点は行の外にぶら下げることができます。

### 行頭字下げ
開き括弧が行頭に来る場合、字下げを行うことができます。

## 5. 文字の重なり防止

### ルール
- 各文字は独立したセルに配置
- セル間の間隔は適切に保つ
- 圏点やルビは本文と重ならないように配置

### チェック項目
- 文字どうしが重なっていないか
- 圏点が文字と重なっていないか
- ルビが隣の文字と重なっていないか
- 行間が適切か

## 6. 縦中横（たてちゅうよこ / Tatechuyoko）

### 定義
縦書き中に横組みで配置する文字列（主に2桁の数字や英単語）。

### 適用対象
- 2桁の数字（例: 12、25）
- 短い英単語（実装により異なる）

### 配置方法
- 文字を横向きに配置
- 全体を1文字分のスペースに収める
- 縦方向の中央に配置

## 実装優先順位

1. **最優先**: 圏点の位置修正（文字の右側中央）
2. **高優先**: 禁則処理の正確な実装
3. **高優先**: 文字の重なり・ズレの修正
4. **中優先**: 約物調整
5. **低優先**: 細かな調整・最適化

## 検証方法

1. 各サンプルのスクリーンショットを撮影
2. 以下をチェック:
   - 圏点が文字の右側中央に来ているか
   - 句読点が行頭に来ていないか
   - 文字が重なっていないか
   - 文字の位置がずれていないか
3. 実際の縦書き文書（Web上の画像等）と比較

## 参考資料

- [W3C 日本語組版処理の要件](https://w3c.github.io/jlreq/)
- [JIS X4051:2004](https://kikakurui.com/x4/X4051-2004-02.html)
- [圏点 - Wikipedia](https://ja.wikipedia.org/wiki/圏点)
- [CSS text-emphasis-position](https://developer.mozilla.org/ja/docs/Web/CSS/text-emphasis-position)
